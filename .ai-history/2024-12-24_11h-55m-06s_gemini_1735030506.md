-- Do you this this function will do the expected thing of removing the oldest files?
-- Also check `history.listHistoryFiles()` to see if the order is correct

function history.removeOldestHistoryFiles()
  local historyDir = aiconfig.getProjectRoot() .. '/.ai-history'
  local files = history.listHistoryFiles()
  common.log("Files in history folder:")
  for i, file in ipairs(files) do
    common.log("File " .. i .. ": " .. file)
  end
  if #files > 10 then
    common.log(string.format("There are d files in the history folder", #files))
    common.logi(string.format("WE need to remove d files", #files - 10))
    for i = #files - 10, 1, -1 do
      local file = files[i]
      local filePath = historyDir .. '/' .. file
      vim.fn.delete(filePath)
      common.log("Deleted oldest history file: " .. filePath)
    end
  else
    common.log("There are less than 10 files in the history folder")
  end
end




# This is Gemini gemini-2.0-flash-thinking-exp answer (8k in, 0k out)

The `history.removeOldestHistoryFiles()` function has a couple of issues:

1. **Incorrect Format Specifier:** Inside the `if #files > 10` block, you have `common.log(string.format("There are d files in the history folder", #files))` and `common.logi(string.format("WE need to remove d files", #files - 10))`.  The `%%%%d` format specifier is missing in both of these.  It should be `%%%%d` to correctly format the number of files.  Additionally, `common.logi` is likely a typo and should be `common.log`.

2. **Off-by-one Error:** The loop `for i = #files - 10, 1, -1 do` will keep 11 files, not 10. If you have 15 files, it will remove indices 5, 4, 3, 2, 1, leaving files 6 through 15 (10 files).  If you want to keep *exactly* 10 files, the loop should start at `#files - 9`.

Here's the corrected `history.removeOldestHistoryFiles()` function:

```lua
function history.removeOldestHistoryFiles()
  local historyDir = aiconfig.getProjectRoot() .. '/.ai-history'
  local files = history.listHistoryFiles()
  common.log("Files in history folder:")
  for i, file in ipairs(files) do
    common.log("File " .. i .. ": " .. file)
  end
  if #files > 10 then
    common.log(string.format("There are %%%%d files in the history folder", #files))
    common.log(string.format("We need to remove %%%%d files", #files - 10))
    for i = #files - 9, 1, -1 do  -- Corrected loop start index
      local file = files[i]
      local filePath = historyDir .. '/' .. file
      vim.fn.delete(filePath)
      common.log("Deleted oldest history file: " .. filePath)
    end
  else
    common.log("There are less than 10 files in the history folder")
  end
end
```

Regarding `history.listHistoryFiles()`, the sorting is done using `table.sort(files)`. This sorts alphabetically.  If your filenames are formatted as `YYYY-MM-DD_HHh-MMm-SSs_model_timestamp.md`, the alphabetical sort *will* result in chronological order because the date and time components are in descending order of significance (year, month, day, hour, minute, second).  So, the sorting is correct for the given filename format.  If you change the filename format, you might need to adjust the sorting logic.  If you want to be explicit about sorting by timestamp, you would need to extract the timestamp from each filename and use that for sorting.



