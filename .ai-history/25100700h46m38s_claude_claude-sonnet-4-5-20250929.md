# Align formatting in `lua/ai/openai/query.lua`

In `lua/ai/openai/query.lua`, ensure that the formatting is consistent with the other `query.lua` files.
Specifically, the `openai/query.lua` file displays tokens without the "k" suffix, while the other files use "k" to denote thousands of tokens.

Give me the full content of the `formatREsults` function from `lua/ai/openai/query.lua`, modified to include the "k" suffix for thousands of tokens.



# ANT Align token formatting in OpenAI query module with GoogleAI and Anthropic

I need to modify the `formatResult` function in `lua/ai/openai/query.lua` to format token counts with the "k" suffix (e.g., "30k", "2k") for consistency with the GoogleAI and Anthropic query modules. Currently, OpenAI displays raw token counts without the "k" suffix, while the other modules format them as thousands.

## Modified file

- `lua/ai/openai/query.lua` (only the `formatResult` function)

## Full content of the modified `formatResult` function

```lua
function query.formatResult(data, upload_url, upload_token, upload_as_public)
  common.log("Inside OpenAI formatResult")

  local prompt_tokens = (type(data.usage) == 'table' and tonumber(data.usage.input_tokens)) or 0
  local completion_tokens = (type(data.usage) == 'table' and tonumber(data.usage.output_tokens)) or 0

  -- Format token counts with "k" suffix for thousands (consistent with GoogleAI and Anthropic)
  local formatted_prompt_tokens = string.format("%gk", math.floor(prompt_tokens / 1000))
  local formatted_completion_tokens = string.format("%gk", math.floor(completion_tokens / 1000))

  local function collect_texts(d)
    local out = {}

    -- Prefer the convenience field if present
    if type(d.output_text) == 'string' and d.output_text ~= '' then
      table.insert(out, d.output_text)
    elseif type(d.output_text) == 'table' then
      for _, s in ipairs(d.output_text) do
        if type(s) == 'string' and s ~= '' then table.insert(out, s) end
      end
    end

    -- Fallback: traverse the output array
    if type(d.output) == 'table' then
      for _, item in ipairs(d.output) do
        if type(item) == 'table' then
          if type(item.text) == 'string' and item.text ~= '' then
            table.insert(out, item.text)
          end
          if type(item.content) == 'table' then
            for _, part in ipairs(item.content) do
              if type(part) == 'table' then
                local t = part.text or part.value
                if type(t) == 'string' and t ~= '' then
                  table.insert(out, t)
                end
              elseif type(part) == 'string' and part ~= '' then
                table.insert(out, part)
              end
            end
          elseif type(item.content) == 'string' and item.content ~= '' then
            table.insert(out, item.content)
          end
        elseif type(item) == 'string' and item ~= '' then
          table.insert(out, item)
        end
      end
    end

    return out
  end

  local pieces = collect_texts(data)
  local text = table.concat(pieces, "\n\n")

  -- Use formatted token counts with "k" suffix
  local result = text
    .. '\n\n'
    .. 'OpenAI ' .. modelUsed .. ' (' .. formatted_prompt_tokens .. ' in, ' .. formatted_completion_tokens .. ' out)\n\n'

  result = common.insertWordToTitle('OPN', result)
  history.saveToHistory('openai_' .. modelUsed, promptToSave .. '\n\n' .. result)

  local model_label = (modelUsed == 'disabled') and 'disabled' or ('OpenAI (' .. modelUsed .. ')')
  common.uploadContent(upload_url, upload_token, result, model_label, upload_as_public)

  return result
end
```

## Explanation of changes

I modified the `formatResult` function in `lua/ai/openai/query.lua` to:

1. **Format token counts with "k" suffix**: Added two new variables `formatted_prompt_tokens` and `formatted_completion_tokens` that use `string.format("%gk", math.floor(tokens / 1000))` to format the token counts as thousands with a "k" suffix.

2. **Use formatted tokens in output**: Changed the result string construction to use `formatted_prompt_tokens` and `formatted_completion_tokens` instead of the raw `prompt_tokens` and `completion_tokens` values.

This change ensures that OpenAI token counts are displayed consistently with GoogleAI and Anthropic modules (e.g., "30k in, 2k out" instead of "30000 in, 2000 out").

Anthropic claude-sonnet-4-5-20250929 (18k in, 1k out)


