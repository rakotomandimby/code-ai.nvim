# Factorize duplicate code 

In `./lua/ai/gemini/query.lua` and `./lua/ai/gemini/answer.lua`, there are many duplicated code blocks. 
We can factorize them into a common function.

I want to create a `./lua/ai/common.lua` file and move the duplicated code blocks into it.
We will not move all duplicated code blocks at once, but start with one block then move the other ones later.

Propose me a first code block to move to `./lua/ai/common.lua` and explain how you would do it.

# This is Gemini answer (7k in, 0k out)

A good candidate for the first refactoring is the `escapePercent` function, which is identical in both `chatgpt/query.lua` and `gemini/query.lua`.

1.  **Create `lua/ai/common.lua`:**

    ```lua
    local common = {}

    function common.escapePercent(s)
      return string.gsub(s, "%%", "%%%%")
    end

    return common
    ```

2.  **Modify `lua/ai/chatgpt/query.lua`:**

    ```lua
    local curl = require('plenary.curl')
    local aiconfig = require('ai.aiconfig')
    local common = require('ai.common')  -- Require the new module
    local query = {}

    -- ... other functions ...

    function query.formatResult(data)
      -- ... (unchanged)
      return common.escapePercent(result) -- Use common.escapePercent
    end

    -- ... other functions ...
    ```

3.  **Modify `lua/ai/gemini/query.lua`:**

    ```lua
    local curl = require('plenary.curl')
    local aiconfig = require('ai.aiconfig')
    local common = require('ai.common') -- Require the new module
    local query = {}

    -- ... other functions

    function query.formatResult(data)
      -- ... other code ...
      result = result .. common.escapePercent(data['candidates'][1]['content']['parts'][1]['text']) .. '\n'
      -- ... other code ...
    end


    -- ... other functions
    ```

By doing this, you've extracted a common function and made it reusable across multiple modules.  You can repeat this process for other duplicated blocks like the logging function (`query.log`) and potentially parts of the `askCallback` function, though the latter might require more careful consideration due to some minor differences in how results are formatted.  Breaking down the refactoring into smaller steps like this makes it easier to manage and test.


# This is ChatGPT answer (6k in, 0k out)

To begin the process of refactoring and moving duplicated code into a common module, we can start by identifying a code block that is both significant and frequently used across the files `lua/ai/gemini/query.lua` and `lua/ai/chatgpt/query.lua`. One such candidate is the `log` function, which is responsible for logging messages to a file. This function is identical in both files and can be easily moved to a common module.

### Step-by-Step Refactoring

1. **Create a Common Module:**
   Create a new file named `lua/ai/common.lua` where we will place the shared code.

2. **Move the `log` Function:**
   Move the `log` function from both `query.lua` files into `common.lua`.

3. **Update the Original Files:**
   Replace the original `log` function in both `query.lua` files with a call to the common module.

### Implementation

#### 1. Create `lua/ai/common.lua`

```lua
-- lua/ai/common.lua
local common = {}

function common.log(message)
  local log_file = io.open("/tmp/aiconfig.log", "a")
  if not log_file then
    error("Could not open log file for writing.")
  end
  log_file:write(message .. "\n")
  log_file:close()
end

return common
```

#### 2. Update `lua/ai/chatgpt/query.lua`

Replace the `log` function with a call to the common module:

```lua
local curl = require('plenary.curl')
local aiconfig = require('ai.aiconfig')
local common = require('ai.common')  -- Import the common module
local query = {}

-- Remove the original log function
-- function query.log(message)
--   local log_file = io.open("/tmp/aiconfig.log", "a")
--   if not log_file then
--     error("Could not open log file for writing.")
--   end
--   log_file:write(message .. "\n\n")
--   log_file:close()
-- end

-- Use the common log function
function query.log(message)
  common.log(message)
end

-- Rest of the file remains unchanged
```

#### 3. Update `lua/ai/gemini/query.lua`

Similarly, replace the `log` function with a call to the common module:

```lua
local curl = require('plenary.curl')
local aiconfig = require('ai.aiconfig')
local common = require('ai.common')  -- Import the common module
local query = {}

-- Remove the original log function
-- function query.log(message)
--   local log_file = io.open("/tmp/aiconfig.log", "a")
--   if not log_file then
--     error("Could not open log file for writing.")
--   end
--   log_file:write(message .. "\n")
--   log_file:close()
-- end

-- Use the common log function
function query.log(message)
  common.log(message)
end

-- Rest of the file remains unchanged
```

### Explanation

- **Common Module (`common.lua`):** This file now contains the `log` function, which can be reused across different modules. This reduces code duplication and centralizes the logging logic.
- **Query Files:** Both `query.lua` files now import the `common` module and use its `log` function, ensuring that any changes to logging behavior only need to be made in one place.

This refactoring step sets the stage for further consolidation of duplicated code, improving maintainability and reducing redundancy in your codebase.


